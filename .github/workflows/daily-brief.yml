name: Daily Brief Automation

on:
  schedule:
    # Runs daily at 10:00 UTC (06:00 Puerto Rico time)
    - cron: '0 10 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-daily-brief:
    runs-on: ubuntu-latest
    env:
      TZ: America/Puerto_Rico

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        run: |
          echo "ðŸ“¦ Installing Python dependencies..."
          pip install -r requirements.txt

      - name: Generate Daily Brief
        id: generate
        run: |
          echo "âš™ï¸ Running Multi-Agent Daily Brief Generator..."
          echo ""

          python scripts/generate_daily_brief.py || {
            echo "âŒ Brief generation failed. Check logs."
            exit 1
          }

          echo "date=$(date -u +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "time=$(date -u +'%H:%M UTC')" >> $GITHUB_OUTPUT

      - name: Verify Output
        run: |
          echo "ðŸ§¾ Verifying generated files..."
          if [ -d "daily" ]; then
            ls -lh daily/
          else
            echo "âš ï¸ No output directory found!"
          fi

      - name: Add Job Summary
        if: always()
        run: |
          {
            echo "## ðŸ“… Daily Brief Generated"
            echo ""
            echo "**Date:** ${{ steps.generate.outputs.date }}"
            echo "**Time:** ${{ steps.generate.outputs.time }}"
            echo ""
            echo "âœ… Daily brief has been generated and committed."
            echo ""
            echo "ðŸ“ Archive: \`daily/${{ steps.generate.outputs.date }}.md\`"
          } >> $GITHUB_STEP_SUMMARY

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: 'ci: update multi-agent Daily Brief for ${{ steps.generate.outputs.date }}'
          file_pattern: 'README.md daily/*.md assets/*'
